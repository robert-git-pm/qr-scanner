<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0a;
    --surface: #111;
    --accent: #00ff88;
    --text: #e8e8e8;
    --muted: #444;
    --border: #1e1e1e;
  }

  body {
    font-family: 'Space Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    overflow: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(0,255,136,0.06) 0%, transparent 70%);
    pointer-events: none;
  }

  h1 {
    font-size: clamp(1rem, 4vw, 1.4rem);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 8px;
    text-align: center;
  }

  .sub {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    color: var(--muted);
    margin-bottom: 40px;
    text-align: center;
  }

  .scanner-wrap {
    position: relative;
    width: min(340px, 90vw);
    aspect-ratio: 1;
    border-radius: 4px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 0 0 1px var(--border), 0 0 40px rgba(0,255,136,0.08);
  }

  video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 2;
  }

  /* Corner brackets */
  .corner {
    position: absolute;
    width: 28px;
    height: 28px;
    border-color: var(--accent);
    border-style: solid;
    opacity: 0.9;
  }
  .corner.tl { top: 16px; left: 16px; border-width: 2px 0 0 2px; }
  .corner.tr { top: 16px; right: 16px; border-width: 2px 2px 0 0; }
  .corner.bl { bottom: 16px; left: 16px; border-width: 0 0 2px 2px; }
  .corner.br { bottom: 16px; right: 16px; border-width: 0 2px 2px 0; }

  /* Scan line */
  .scanline {
    position: absolute;
    left: 16px; right: 16px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scan 2.4s ease-in-out infinite;
    opacity: 0.7;
  }
  @keyframes scan {
    0% { top: 16px; }
    50% { top: calc(100% - 16px); }
    100% { top: 16px; }
  }

  .found .scanline { animation: none; opacity: 0; }
  .found .corner { border-color: #fff; opacity: 1; }

  #status {
    margin-top: 28px;
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    color: var(--muted);
    min-height: 1.4em;
    text-align: center;
    transition: color 0.3s;
  }
  #status.ok { color: var(--accent); }
  #status.err { color: #ff4455; }

  #startBtn {
    margin-top: 32px;
    padding: 14px 36px;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 2px;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
  }
  #startBtn:hover {
    background: var(--accent);
    color: #000;
    box-shadow: 0 0 20px rgba(0,255,136,0.3);
  }
  #startBtn:active { transform: scale(0.97); }
  #startBtn.hidden { display: none; }
</style>
</head>
<body>

<h1>QR Scanner</h1>
<p class="sub">// kamera → erkennung → weiterleitung</p>

<div class="scanner-wrap" id="scannerWrap">
  <video id="video" autoplay playsinline muted></video>
  <div class="overlay">
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
    <div class="scanline"></div>
  </div>
</div>

<p id="status">Kamera inaktiv</p>
<button id="startBtn" onclick="startCamera()">Kamera starten</button>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
const video = document.getElementById('video');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const wrap = document.getElementById('scannerWrap');

let scanning = false;
let animFrame;
let detector;
let jsqrCanvas, jsqrCtx;
const useNative = 'BarcodeDetector' in window;

function showErr(msg) {
  status.textContent = msg;
  status.className = 'err';
  startBtn.classList.remove('hidden');
}

function handleResult(data) {
  scanning = false;
  wrap.classList.add('found');
  status.textContent = '✓ QR-Code erkannt – weiterleitung...';
  status.className = 'ok';
  setTimeout(() => {
    let url = data;
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    window.location.href = url;
  }, 800);
}

async function startCamera() {
  try {
    startBtn.classList.add('hidden');
    status.textContent = 'Kamera wird gestartet...';
    status.className = '';

    if (!window.isSecureContext) {
      showErr('Seite muss über HTTPS geöffnet werden – lokale Dateien (file://) funktionieren nicht');
      return;
    }

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      showErr('Kamera-API nicht verfügbar – Seite muss über HTTPS geöffnet werden');
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }
    });
    video.srcObject = stream;
    await video.play();

    if (useNative) {
      detector = new BarcodeDetector({ formats: ['qr_code'] });
    } else {
      jsqrCanvas = document.createElement('canvas');
      jsqrCtx = jsqrCanvas.getContext('2d');
    }

    scanning = true;
    status.textContent = 'QR-Code in den Rahmen halten';
    tick();
  } catch (e) {
    console.error('Kamerafehler:', e.name, e.message);
    if (e.name === 'NotAllowedError') {
      showErr('Berechtigung verweigert – bitte in den Browser-Einstellungen erlauben');
    } else if (e.name === 'NotFoundError') {
      showErr('Keine Kamera gefunden');
    } else if (e.name === 'NotReadableError') {
      showErr('Kamera wird bereits von einer anderen App verwendet');
    } else {
      showErr('Fehler: ' + e.name + (e.message ? ' – ' + e.message : ''));
    }
  }
}

async function tick() {
  if (!scanning) return;
  try {
    if (useNative) {
      const codes = await detector.detect(video);
      if (codes.length > 0) { handleResult(codes[0].rawValue.trim()); return; }
    } else {
      jsqrCanvas.width = video.videoWidth;
      jsqrCanvas.height = video.videoHeight;
      jsqrCtx.drawImage(video, 0, 0);
      const imageData = jsqrCtx.getImageData(0, 0, jsqrCanvas.width, jsqrCanvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) { handleResult(code.data.trim()); return; }
    }
  } catch (e) {
    // einzelne Frames können fehlschlagen – ignorieren
  }
  if (scanning) animFrame = requestAnimationFrame(tick);
}
</script>
</body>
</html>
